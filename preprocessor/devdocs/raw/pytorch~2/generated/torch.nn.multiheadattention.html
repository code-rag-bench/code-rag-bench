<h1 id="multiheadattention">MultiheadAttention</h1> <dl class="py class"> <dt class="sig sig-object py" id="torch.nn.MultiheadAttention">
<code>class torch.nn.MultiheadAttention(embed_dim, num_heads, dropout=0.0, bias=True, add_bias_kv=False, add_zero_attn=False, kdim=None, vdim=None, batch_first=False, device=None, dtype=None)</code> <a class="reference internal" href="https://pytorch.org/docs/2.1/_modules/torch/nn/modules/activation.html#MultiheadAttention"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Allows the model to jointly attend to information from different representation subspaces as described in the paper: <a class="reference external" href="https://arxiv.org/abs/1706.03762">Attention Is All You Need</a>.</p> <p>Multi-Head Attention is defined as:</p> <div class="math"> <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><mi>h</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>h</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(head_1,\dots,head_h)W^O </annotation></semantics></math></span></span></span>
</div>
<p>where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>e</mi><mi>a</mi><msub><mi>d</mi><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">head_i = \text{Attention}(QW_i^Q, KW_i^K, VW_i^V)</annotation></semantics></math></span></span></span>.</p> <p><code>nn.MultiHeadAttention</code> will use the optimized implementations of <code>scaled_dot_product_attention()</code> when possible.</p> <p>In addition to support for the new <code>scaled_dot_product_attention()</code> function, for speeding up Inference, MHA will use fastpath inference with support for Nested Tensors, iff:</p> <ul class="simple"> <li>self attention is being computed (i.e., <code>query</code>, <code>key</code>, and <code>value</code> are the same tensor).</li> <li>inputs are batched (3D) with <code>batch_first==True</code>
</li> <li>Either autograd is disabled (using <code>torch.inference_mode</code> or <code>torch.no_grad</code>) or no tensor argument <code>requires_grad</code>
</li> <li>training is disabled (using <code>.eval()</code>)</li> <li>
<code>add_bias_kv</code> is <code>False</code>
</li> <li>
<code>add_zero_attn</code> is <code>False</code>
</li> <li>
<code>batch_first</code> is <code>True</code> and the input is batched</li> <li>
<code>kdim</code> and <code>vdim</code> are equal to <code>embed_dim</code>
</li> <li>if a <a class="reference external" href="https://pytorch.org/docs/stable/nested.html">NestedTensor</a> is passed, neither <code>key_padding_mask</code> nor <code>attn_mask</code> is passed</li> <li>autocast is disabled</li> </ul> <p>If the optimized inference fastpath implementation is in use, a <a class="reference external" href="https://pytorch.org/docs/stable/nested.html">NestedTensor</a> can be passed for <code>query</code>/<code>key</code>/<code>value</code> to represent padding more efficiently than using a padding mask. In this case, a <a class="reference external" href="https://pytorch.org/docs/stable/nested.html">NestedTensor</a> will be returned, and an additional speedup proportional to the fraction of the input that is padding can be expected.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>embed_dim</strong> – Total dimension of the model.</li> <li>
<strong>num_heads</strong> – Number of parallel attention heads. Note that <code>embed_dim</code> will be split across <code>num_heads</code> (i.e. each head will have dimension <code>embed_dim // num_heads</code>).</li> <li>
<strong>dropout</strong> – Dropout probability on <code>attn_output_weights</code>. Default: <code>0.0</code> (no dropout).</li> <li>
<strong>bias</strong> – If specified, adds bias to input / output projection layers. Default: <code>True</code>.</li> <li>
<strong>add_bias_kv</strong> – If specified, adds bias to the key and value sequences at dim=0. Default: <code>False</code>.</li> <li>
<strong>add_zero_attn</strong> – If specified, adds a new batch of zeros to the key and value sequences at dim=1. Default: <code>False</code>.</li> <li>
<strong>kdim</strong> – Total number of features for keys. Default: <code>None</code> (uses <code>kdim=embed_dim</code>).</li> <li>
<strong>vdim</strong> – Total number of features for values. Default: <code>None</code> (uses <code>vdim=embed_dim</code>).</li> <li>
<strong>batch_first</strong> – If <code>True</code>, then the input and output tensors are provided as (batch, seq, feature). Default: <code>False</code> (seq, batch, feature).</li> </ul> </dd> </dl> <p>Examples:</p> <pre data-language="python">&gt;&gt;&gt; multihead_attn = nn.MultiheadAttention(embed_dim, num_heads)
&gt;&gt;&gt; attn_output, attn_output_weights = multihead_attn(query, key, value)
</pre> <dl class="py method"> <dt class="sig sig-object py" id="torch.nn.MultiheadAttention.forward">
<code>forward(query, key, value, key_padding_mask=None, need_weights=True, attn_mask=None, average_attn_weights=True, is_causal=False)</code> <a class="reference internal" href="https://pytorch.org/docs/2.1/_modules/torch/nn/modules/activation.html#MultiheadAttention.forward"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>query</strong> (<a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a>) – Query embeddings of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>q</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, E_q)</annotation></semantics></math></span></span></span> for unbatched input, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><mi>N</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>q</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, N, E_q)</annotation></semantics></math></span></span></span> when <code>batch_first=False</code> or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>q</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, L, E_q)</annotation></semantics></math></span></span></span> when <code>batch_first=True</code>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span></span></span> is the target sequence length, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">E_q</annotation></semantics></math></span></span></span> is the query embedding dimension <code>embed_dim</code>. Queries are compared against key-value pairs to produce the output. See “Attention Is All You Need” for more details.</li> <li>
<strong>key</strong> (<a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a>) – Key embeddings of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S, E_k)</annotation></semantics></math></span></span></span> for unbatched input, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><mi>N</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S, N, E_k)</annotation></semantics></math></span></span></span> when <code>batch_first=False</code> or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, S, E_k)</annotation></semantics></math></span></span></span> when <code>batch_first=True</code>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span></span></span> is the source sequence length, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">E_k</annotation></semantics></math></span></span></span> is the key embedding dimension <code>kdim</code>. See “Attention Is All You Need” for more details.</li> <li>
<strong>value</strong> (<a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a>) – Value embeddings of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S, E_v)</annotation></semantics></math></span></span></span> for unbatched input, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><mi>N</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S, N, E_v)</annotation></semantics></math></span></span></span> when <code>batch_first=False</code> or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>E</mi><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, S, E_v)</annotation></semantics></math></span></span></span> when <code>batch_first=True</code>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span></span></span> is the source sequence length, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">E_v</annotation></semantics></math></span></span></span> is the value embedding dimension <code>vdim</code>. See “Attention Is All You Need” for more details.</li> <li>
<strong>key_padding_mask</strong> (<a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.12)">Optional</a><em>[</em><a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a><em>]</em>) – If specified, a mask of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, S)</annotation></semantics></math></span></span></span> indicating which elements within <code>key</code> to ignore for the purpose of attention (i.e. treat as “padding”). For unbatched <code>query</code>, shape should be <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S)</annotation></semantics></math></span></span></span>. Binary and float masks are supported. For a binary mask, a <code>True</code> value indicates that the corresponding <code>key</code> value will be ignored for the purpose of attention. For a float mask, it will be directly added to the corresponding <code>key</code> value.</li> <li>
<strong>need_weights</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)">bool</a>) – If specified, returns <code>attn_output_weights</code> in addition to <code>attn_outputs</code>. Set <code>need_weights=False</code> to use the optimized <code>scaled_dot_product_attention</code> and achieve the best performance for MHA. Default: <code>True</code>.</li> <li>
<strong>attn_mask</strong> (<a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.12)">Optional</a><em>[</em><a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a><em>]</em>) – If specified, a 2D or 3D mask preventing attention to certain positions. Must be of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, S)</annotation></semantics></math></span></span></span> or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo>⋅</mo><mtext>num_heads</mtext><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N\cdot\text{num\_heads}, L, S)</annotation></semantics></math></span></span></span>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span></span></span> is the target sequence length, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span></span></span> is the source sequence length. A 2D mask will be broadcasted across the batch while a 3D mask allows for a different mask for each entry in the batch. Binary and float masks are supported. For a binary mask, a <code>True</code> value indicates that the corresponding position is not allowed to attend. For a float mask, the mask values will be added to the attention weight. If both attn_mask and key_padding_mask are supplied, their types should match.</li> <li>
<strong>average_attn_weights</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)">bool</a>) – If true, indicates that the returned <code>attn_weights</code> should be averaged across heads. Otherwise, <code>attn_weights</code> are provided separately per head. Note that this flag only has an effect when <code>need_weights=True</code>. Default: <code>True</code> (i.e. average weights across heads)</li> <li>
<strong>is_causal</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.12)">bool</a>) – If specified, applies a causal mask as attention mask. Default: <code>False</code>. Warning: <code>is_causal</code> provides a hint that <code>attn_mask</code> is the causal mask. Providing incorrect hints can result in incorrect execution, including forward and backward compatibility.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Tuple" title="(in Python v3.12)">Tuple</a>[<a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a>, <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.12)">Optional</a>[<a class="reference internal" href="../tensors#torch.Tensor" title="torch.Tensor">Tensor</a>]]</p> </dd> </dl> <dl> <dt>Outputs:</dt>
<dd>
<ul class="simple"> <li>
<strong>attn_output</strong> - Attention outputs of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, E)</annotation></semantics></math></span></span></span> when input is unbatched, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><mi>N</mi><mo separator="true">,</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, N, E)</annotation></semantics></math></span></span></span> when <code>batch_first=False</code> or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, L, E)</annotation></semantics></math></span></span></span> when <code>batch_first=True</code>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span></span></span> is the target sequence length, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span></span></span> is the embedding dimension <code>embed_dim</code>.</li> <li>
<strong>attn_output_weights</strong> - Only returned when <code>need_weights=True</code>. If <code>average_attn_weights=True</code>, returns attention weights averaged across heads of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(L, S)</annotation></semantics></math></span></span></span> when input is unbatched or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, L, S)</annotation></semantics></math></span></span></span>, where <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span></span></span> is the batch size, <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span></span></span> is the target sequence length, and <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span></span></span> is the source sequence length. If <code>average_attn_weights=False</code>, returns attention weights per head of shape <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext>num_heads</mtext><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{num\_heads}, L, S)</annotation></semantics></math></span></span></span> when input is unbatched or <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mtext>num_heads</mtext><mo separator="true">,</mo><mi>L</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N, \text{num\_heads}, L, S)</annotation></semantics></math></span></span></span>.</li> </ul> <div class="admonition note"> <p class="admonition-title">Note</p> <p><code>batch_first</code> argument is ignored for unbatched inputs.</p> </div> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="torch.nn.MultiheadAttention.merge_masks">
<code>merge_masks(attn_mask, key_padding_mask, query)</code> <a class="reference internal" href="https://pytorch.org/docs/2.1/_modules/torch/nn/modules/activation.html#MultiheadAttention.merge_masks"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Determine mask type and combine masks if necessary. If only one mask is provided, that mask and the corresponding mask type will be returned. If both masks are provided, they will be both expanded to shape <code>(batch_size, num_heads, seq_len, seq_len)</code>, combined with logical <code>or</code> and mask type 2 will be returned :param attn_mask: attention mask of shape <code>(seq_len, seq_len)</code>, mask type 0 :param key_padding_mask: padding mask of shape <code>(batch_size, seq_len)</code>, mask type 1 :param query: query embeddings of shape <code>(batch_size, seq_len, embed_dim)</code></p> <dl class="field-list simple"> <dt class="field-odd">Returns</dt> <dd class="field-odd">
<p>merged mask mask_type: merged mask type (0, 1, or 2)</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>merged_mask</p> </dd> </dl> </dd>
</dl> </dd>
</dl><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2024, PyTorch Contributors<br>PyTorch has a BSD-style license, as found in the <a href="https://github.com/pytorch/pytorch/blob/main/LICENSE">LICENSE</a> file.<br>
    <a href="https://pytorch.org/docs/2.1/generated/torch.nn.MultiheadAttention.html" class="_attribution-link">https://pytorch.org/docs/2.1/generated/torch.nn.MultiheadAttention.html</a>
  </p>
</div>
